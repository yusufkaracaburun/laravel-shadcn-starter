services:
  # Development profile - SQLite, dev dependencies, hot reloading
  api:
    build:
      context: ..
      dockerfile: .deployment/Dockerfile.dev
    container_name: laravel-api
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ../:/var/www/html
      - ../storage:/var/www/html/storage
    ports:
      - "${APP_PORT:-8000}:80"
    environment:
      - APP_ENV=${APP_ENV:-local}
      - APP_DEBUG=${APP_DEBUG:-true}
      - DB_CONNECTION=${DB_CONNECTION:-sqlite}
      - DB_DATABASE=${DB_DATABASE:-database/database.sqlite}
    networks:
      - laravel
    profiles:
      - dev
      - default
    command: >
      sh -c "
        if [ ! -f .env ]; then
          cp .env.example .env
        fi &&
        composer install &&
        php artisan key:generate --ansi || true &&
        php artisan migrate --force || true &&
        frankenphp php-server -r public/
      "

  # Staging profile - MySQL, Redis, production-like but with debugging
  api-staging:
    build:
      context: ..
      dockerfile: .deployment/Dockerfile
    container_name: laravel-api-staging
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8001}:80"
    environment:
      - APP_ENV=staging
      - APP_DEBUG=true
      - APP_URL=${APP_URL:-http://localhost:8001}
      - DB_CONNECTION=${DB_CONNECTION:-mysql}
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE:-laravel}
      - DB_USERNAME=${DB_USERNAME:-laravel}
      - DB_PASSWORD=${DB_PASSWORD:-password}
      - CACHE_DRIVER=${CACHE_DRIVER:-redis}
      - SESSION_DRIVER=${SESSION_DRIVER:-redis}
      - QUEUE_CONNECTION=${QUEUE_CONNECTION:-redis}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ../storage:/var/www/html/storage
    networks:
      - laravel
    profiles:
      - staging
    depends_on:
      - mysql-staging
      - redis-staging

  # Production profile - MySQL, Redis, optimized, no debugging
  api-prod:
    build:
      context: ..
      dockerfile: .deployment/Dockerfile
    container_name: laravel-api-prod
    restart: unless-stopped
    ports:
      - "${APP_PORT:-80}:80"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_URL=${APP_URL:-http://localhost}
      - DB_CONNECTION=${DB_CONNECTION:-mysql}
      - DB_HOST=mysql-prod
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE:-laravel}
      - DB_USERNAME=${DB_USERNAME:-laravel}
      - DB_PASSWORD=${DB_PASSWORD}
      - CACHE_DRIVER=${CACHE_DRIVER:-redis}
      - SESSION_DRIVER=${SESSION_DRIVER:-redis}
      - QUEUE_CONNECTION=${QUEUE_CONNECTION:-redis}
      - REDIS_HOST=redis-prod
      - REDIS_PORT=6379
    volumes:
      - ../storage:/var/www/html/storage
    networks:
      - laravel
    profiles:
      - prod
    depends_on:
      - mysql-prod
      - redis-prod

  # MySQL for staging
  mysql-staging:
    image: mysql:8.0
    container_name: laravel-mysql-staging
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-laravel}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-password}
      MYSQL_PASSWORD: ${DB_PASSWORD:-password}
      MYSQL_USER: ${DB_USERNAME:-laravel}
    volumes:
      - mysql_staging_data:/var/lib/mysql
    networks:
      - laravel
    profiles:
      - staging
    ports:
      - "${DB_PORT:-3307}:3306"

  # MySQL for production
  mysql-prod:
    image: mysql:8.0
    container_name: laravel-mysql-prod
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-laravel}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_USER: ${DB_USERNAME:-laravel}
    volumes:
      - mysql_prod_data:/var/lib/mysql
    networks:
      - laravel
    profiles:
      - prod

  # Redis for staging
  redis-staging:
    image: redis:7-alpine
    container_name: laravel-redis-staging
    restart: unless-stopped
    networks:
      - laravel
    volumes:
      - redis_staging_data:/data
    profiles:
      - staging
    ports:
      - "${REDIS_PORT:-6380}:6379"

  # Redis for production
  redis-prod:
    image: redis:7-alpine
    container_name: laravel-redis-prod
    restart: unless-stopped
    networks:
      - laravel
    volumes:
      - redis_prod_data:/data
    profiles:
      - prod

networks:
  laravel:
    driver: bridge

volumes:
  mysql_staging_data:
    driver: local
  mysql_prod_data:
    driver: local
  redis_staging_data:
    driver: local
  redis_prod_data:
    driver: local
