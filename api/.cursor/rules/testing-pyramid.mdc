---
description: Testing Pyramid guidelines for backend/API test files only - enforces proper test structure, naming conventions, and pyramid principles for PHP/Pest tests
globs:
  - "tests/**/*Test.php"
  - "tests/**/*.php"
alwaysApply: false
---

# Testing Pyramid Rules for Backend API Tests

When writing or modifying backend test files, strictly follow the Testing Pyramid principles as defined in `@guides/testing-pyramid.md`.

## Test Type Identification and Naming

### File Naming Conventions (MANDATORY)

- **Unit Tests**: Must use `*Test.php` suffix
  - Location: `tests/Unit/**/*Test.php`
  - Example: `tests/Unit/UserModelTest.php`
  - Example: `tests/Unit/CreateNewUserTest.php`

- **Feature Tests**: Must use `*Test.php` suffix
  - Location: `tests/Feature/**/*Test.php`
  - Example: `tests/Feature/Auth/LoginTest.php`
  - Example: `tests/Feature/Auth/RegisterTest.php`
  - Example: `tests/Feature/Api/ApiTest.php`

- **Pact Tests**: Must use `*Test.php` or `*PactTest.php` suffix
  - Location: `tests/Pact/**/*Test.php`
  - Example: `tests/Pact/UserServicePactTest.php`

## Test Structure (REQUIRED)

All PHP/Pest tests MUST follow this structure:

```php
<?php

declare(strict_types=1);

use App\Models\User;
use Illuminate\Support\Facades\Hash;

test('descriptive test name explaining what is being tested', function () {
    // Arrange
    $user = User::factory()->create([
        'email' => 'test@example.com',
        'password' => Hash::make('password123'),
    ]);

    // Act
    $response = $this->postJson('/login', [
        'email' => 'test@example.com',
        'password' => 'password123',
    ]);

    // Assert
    $response->assertStatus(200);
    expect($response->json())->toHaveKey('two_factor');
});
```

### Grouping Related Tests

For multiple related tests, use descriptive test names that group by feature:

```php
test('user can login with valid credentials', function () {
    // Arrange, Act, Assert
});

test('user cannot login with invalid credentials', function () {
    // Arrange, Act, Assert
});

test('user cannot login with missing email', function () {
    // Arrange, Act, Assert
});
```

## Test Type Guidelines

### Unit Tests (`tests/Unit/**/*Test.php`)

**MUST**:
- Test individual units of code (models, actions, services) in isolation
- Run in milliseconds (very fast)
- Have no external dependencies (mock everything external)
- Test business logic, data transformations, edge cases
- Use one assertion per test when possible
- Follow AAA pattern (Arrange, Act, Assert)
- Use `RefreshDatabase` trait when needed for database operations

**MUST NOT**:
- Test framework code (Laravel, Pest)
- Test third-party libraries
- Use real external services (mock these)
- Test HTTP layer (use Feature tests)
- Test implementation details (test behavior, not how)

**Example**:
```php
test('user model has fillable attributes', function () {
    // Arrange
    $user = new User();
    
    // Act
    $fillable = $user->getFillable();
    
    // Assert
    expect($fillable)->toEqual(['name', 'email', 'password']);
});

test('user password is hashed when created', function () {
    // Arrange
    $password = 'password123';
    
    // Act
    $user = User::factory()->create(['password' => $password]);
    
    // Assert
    expect(Hash::check($password, $user->password))->toBeTrue();
    expect($user->password)->not->toBe($password);
});
```

### Feature Tests (`tests/Feature/**/*Test.php`)

**MUST**:
- Test HTTP endpoints and API routes
- Test request/response handling
- Test authentication and authorization
- Test validation and error handling
- Use real database (with `RefreshDatabase` trait)
- Test complete request/response cycle
- Test status codes and response structure

**MUST NOT**:
- Test business logic details (use unit tests)
- Mock the HTTP layer itself
- Test framework routing (test your routes)
- Duplicate unit test coverage

**Example**:
```php
test('user can login with valid credentials', function () {
    // Arrange
    $user = User::factory()->create([
        'email' => 'test@example.com',
        'password' => Hash::make('password123'),
    ]);

    // Act
    $response = $this->postJson('/login', [
        'email' => 'test@example.com',
        'password' => 'password123',
    ]);

    // Assert
    $response->assertStatus(200);
    $response->assertJsonStructure(['two_factor']);
    expect($response->json('two_factor'))->toBeFalse();
});

test('user cannot login with invalid credentials', function () {
    // Arrange
    User::factory()->create([
        'email' => 'test@example.com',
        'password' => Hash::make('password123'),
    ]);

    // Act
    $response = $this->postJson('/login', [
        'email' => 'test@example.com',
        'password' => 'wrongpassword',
    ]);

    // Assert
    $response->assertStatus(422);
    $response->assertJsonValidationErrors(['email']);
});
```

### Pact Tests (`tests/Pact/**/*Test.php`)

**MUST**:
- Test API contracts between services
- Verify request/response contracts
- Use Pact framework for contract testing
- Test consumer and provider contracts

**MUST NOT**:
- Test business logic (use unit/feature tests)
- Duplicate feature test coverage

## Testing Pyramid Distribution

Maintain the pyramid shape:

- **70-80%**: Unit tests (`tests/Unit/**/*Test.php`)
- **15-20%**: Feature tests (`tests/Feature/**/*Test.php`)
- **5-10%**: Pact tests (`tests/Pact/**/*Test.php`)

## Test Quality Requirements

### Speed Requirements
- Unit tests: < 1 second total execution
- Feature tests: < 30 seconds total
- Pact tests: < 1 minute total

### Independence Requirements
- Tests MUST be independent (no dependencies between tests)
- Tests MUST be runnable in any order
- Tests MUST clean up after themselves (use `RefreshDatabase` trait)
- Tests MUST be idempotent

### Readability Requirements
- Use descriptive test names that explain what is being tested
- Follow AAA pattern (Arrange, Act, Assert)
- Keep tests focused (one thing per test)
- Use clear variable names
- Add comments for complex setup
- Use Pest's `expect()` API for assertions

## Pest-Specific Guidelines

### Using Pest Helpers

**Database Operations**:
- Use `RefreshDatabase` trait in `TestCase.php` for automatic cleanup
- Use factories for test data creation
- Use `DatabaseMigrations` if needed for specific migrations

**Assertions**:
- Prefer Pest's `expect()` API over PHPUnit assertions
- Use `expect()->toBe()`, `expect()->toEqual()`, `expect()->toHaveKey()`, etc.
- Use Laravel's `assertStatus()`, `assertJson()`, `assertJsonValidationErrors()` for HTTP responses

**Test Organization**:
- Group related tests in the same file
- Use descriptive test names that read like specifications
- Use `test()` function, not class-based tests

**Example**:
```php
test('user can register with valid data', function () {
    $response = $this->postJson('/register', [
        'name' => 'John Doe',
        'email' => 'john@example.com',
        'password' => 'password123',
        'password_confirmation' => 'password123',
    ]);

    $response->assertStatus(201);
    $this->assertDatabaseHas('users', ['email' => 'john@example.com']);
});
```

## Anti-Patterns to Avoid

**DO NOT**:
1. Create "ice cream cone" (many Feature tests, few Unit tests)
2. Test implementation details instead of behavior
3. Over-mock (only mock external dependencies)
4. Test framework code (Laravel, Pest)
5. Duplicate tests at multiple levels
6. Write slow unit tests (they should be fast)
7. Skip database cleanup (always use `RefreshDatabase`)
8. Test private methods directly (test through public interface)
9. Use class-based PHPUnit tests (use Pest's functional style)

## Test Organization

Tests MUST be organized in this structure:

```
tests/
  Unit/           # Unit tests (*Test.php)
  Feature/        # Feature/Integration tests (*Test.php)
    Api/          # API-specific feature tests
    Auth/         # Authentication feature tests
  Pact/           # Pact contract tests (*Test.php)
  TestCase.php    # Base test case with RefreshDatabase
  Pest.php        # Pest configuration
```

## Laravel-Specific Guidelines

### Database Testing

**ALWAYS**:
- Use `RefreshDatabase` trait in `TestCase.php`
- Use factories for creating test data
- Use `assertDatabaseHas()` and `assertDatabaseMissing()` for database assertions

**Example**:
```php
test('user is created in database after registration', function () {
    $response = $this->postJson('/register', [
        'name' => 'John Doe',
        'email' => 'john@example.com',
        'password' => 'password123',
        'password_confirmation' => 'password123',
    ]);

    $this->assertDatabaseHas('users', [
        'email' => 'john@example.com',
        'name' => 'John Doe',
    ]);
});
```

### HTTP Testing

**ALWAYS**:
- Use `getJson()`, `postJson()`, `putJson()`, `deleteJson()` for API testing
- Use `assertStatus()` for status code assertions
- Use `assertJson()` and `assertJsonStructure()` for JSON responses
- Use `assertJsonValidationErrors()` for validation errors

### Authentication Testing

**ALWAYS**:
- Use `actingAs()` for authenticated requests
- Test both authenticated and unauthenticated scenarios
- Test authorization rules

**Example**:
```php
test('authenticated user can access protected route', function () {
    $user = User::factory()->create();
    
    $response = $this->actingAs($user)
        ->getJson('/api/user');
    
    $response->assertStatus(200);
    expect($response->json('email'))->toBe($user->email);
});
```

## When Creating New Tests

Before writing a test, ask:

1. **What am I testing?**
   - Business logic → Unit test (`tests/Unit/`)
   - HTTP endpoint → Feature test (`tests/Feature/`)
   - API contract → Pact test (`tests/Pact/`)

2. **Is this the right level?**
   - Can this be tested at a lower level? (Push tests down)
   - Am I duplicating a test from another level? (Avoid duplication)

3. **Is this test independent?**
   - Can it run in any order?
   - Does it clean up after itself? (RefreshDatabase)
   - Is it idempotent?

4. **Is this test maintainable?**
   - Clear, descriptive name?
   - Follows AAA pattern?
   - Tests behavior, not implementation?
   - Uses Pest's `expect()` API?

## Reference

For complete guidelines, see: `@guides/testing-pyramid.md`
